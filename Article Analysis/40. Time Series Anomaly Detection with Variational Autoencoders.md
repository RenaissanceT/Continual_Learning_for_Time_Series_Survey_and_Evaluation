
# [Time Series Anomaly Detection with Variational Autoencoders](https://arxiv.org/abs/1907.01702v1)

----

<img width="1366" alt="Screenshot 2025-04-02 at 1 09 04 AM" src="https://github.com/user-attachments/assets/3007dc19-7831-4d69-83e9-8939a2dfe468" />

-----

**领域** : 

属于增量学习，时间序列的异常检测问题

**分类** : 

增量学习中的**异常检测**

**多任务** : 

实验部分涉及多个数据集

**场景** : 

设定场景是**时间序列的异常检测**，目标是通过变分自编码器（VAE）提高对异常数据的识别能力, 该方法属于在线学习

**问题** : 

研究问题是**如何在时间序列数据中进行稳定的异常检测**，同时减少误报和漏报。异常的划分基于**数据点的重构误差**，不同时间阶段的数据分布不同，导致模型需要适应多个数据分布。

![image](https://github.com/user-attachments/assets/7a1b29bb-a996-4d7c-8f65-b49ff121361c)

**方法** : 

提出**LSTM-VAE模型**，通过**长短时记忆网络（LSTM）作为编码器和解码器** 来优化模型适应性。属于**异常检测**，以及属于 **Replay Methods**

**为什么** : 

采用LSTM-VAE框架的原因是通过结合LSTM和VAE，能够更有效地适应数据流的变化，提高时间序列异常检测的长期稳定性。

-----

## **论文背景**

针对模型的重构能力和异常分数的计算，该文提出了一种基于变分自动编码器模型（VAE）的时间序列异常检测方法，并结合再编码器和潜在约束网络（VELC）。为了修改模型的重建能力，防止其很好地重建异常样本，我们在 VAE 的潜在空间中增加了一个约束网络，以迫使它生成与训练样本相似的新潜在变量。为了能够计算两个特征空间中的异常分数，我们训练了一个 re-encoder 将生成的数据转换为新的潜在空间。为了更好地处理时间序列，我们使用 LSTM 作为 VAE 框架的编码器和解码器部分。几个基准测试的实验结果表明，我们的方法优于最先进的异常检测方法。

本论文提出了一种基于 LSTM 的变分自编码器（LSTM-VAE）和生成对抗机制结合的无监督异常检测方法（LVEAD）。它利用深度学习的方法，通过对时间序列正常数据的建模，当新输入的数据与模型无法很好拟合时，则被判定为异常。该方法融合了编码-解码-再编码结构，并以潜在向量误差和重构误差作为异常判别依据。实验表明该方法在多个公开数据集上优于现有的一些主流异常检测方法。

#### 根据是否在训练阶段使用标签，异常检测算法可以分为：

（1） **有监督方法**：依赖标注数据，通常需要专业知识和大量时间成本

异常数据往往类别不平衡或特征未知，不适合真实数据 

（2）**无监督方法**： 不需要标注数据，适用于实际应用场景

传统方法假设异常是“少数类”和“不同”的：基于距离的方法 / 基于密度的方法 / 基于角度的方法 

局限性：高维数据会导致相似度计算不准、计算复杂度高、划分准确率低 / 简单降维虽可降低复杂度，但会丢失细节信息 / 异常比例通常未知，难以设定阈值

#### 基于深度学习的无监督异常检测方法应运而生，主要分为两类：

  1. **基于预测误差的方法**：检测输入样本与模型输出之间的误差

方法：
1.1 使用 LSTM 预测误差分布来计算异常分数
1.2 用正常数据训练自动编码器（AE），通过隐藏层和 SSIM 特征检测异常
1.3 提出 RAD：将稳健主成分分析（rPCA）与 AE 结合，把噪声矩阵视为异常数据

  2. **基于生成模型的重建误差方法**：用正常数据训练生成模型，测试时根据重建误差判别异常
     
方法：
2.1 使用变分推理和 RNN 构建 STERN 模型，用于机器人时间序列异常检测 
2.2 提出基于 VAE 的方法，引入新的概率异常分数
2.3 提出 DAGMM 框架：结合深度 AE 和高斯混合模型（GMM），以压缩数据与重建误差作为新特征
2.4 介绍 AnoGAN：用 GAN 生成最接近测试样本的样本，基于 L2 距离检测异常
2.5 提出 ALAD：基于双向 GAN 的对抗性学习方法，在潜在空间加入判别器，显著提升检测速度
       - 
## 算法逻辑与步骤方法

模型由原始 VAE 的编码器和解码器、re-Encoder 和约束网络四部分组成，它可以获得对法态数据更好的建模能力。为了提取时间序列的特征，编码器、解码器和 re-Encoder 都使用双向 LSTM 网络。

![image](https://github.com/user-attachments/assets/bf2da41c-8bae-4b72-b562-3782c970cd9a)

（VELC 的网络结构。两个橙色块是 VAE 的编码器层和解码器层，绿色块是 re-Encoder 层，蓝色部分是约束网络。）

### 1. 网络结构

- **编码器（Encoder）**：使用 BiLSTM 对输入时间序列 X 编码，得到潜在表示（近似为高斯分布的均值 mu 和方差 sigma）。
- **解码器（Decoder）**：同样采用 LSTM，通过重参数技巧，从潜在空间采样，重构输入数据 \(\hat{X}\)。
- **再编码器（Re-Encoder）**：对重构后的时间序列 \(\hat{X}\) 再次进行编码，获得潜在向量 \(\hat{z}\)。
- **判别器/对抗机制（Discriminator）**：极大化原始和重建样本在特征空间的距离，提升判别能力。

### 2. 损失函数

总体损失由三部分组成（见公式7）：  

![image](https://github.com/user-attachments/assets/ada703b5-ae71-4414-9f48-d2f13557364a)

- **重构损失 \(L_{rec}\)**：原始序列与重构序列的 \(L_1\) 距离。

![image](https://github.com/user-attachments/assets/6a484e4b-cae6-4cd7-937b-19c6dfe0a228)

- **对抗损失 \(L_{adv}\)**：判别器特征空间中的距离，用于提升生成器鲁棒性。

![image](https://github.com/user-attachments/assets/8c04b416-c31d-4834-b5b8-5d81cacb0274)

- **潜在向量损失 \(L_{enc}\)**：原始数据经编码器编码的潜在向量与重构数据再编码得到的潜在向量的 \(L_1\) 距离。

![image](https://github.com/user-attachments/assets/1ee9aaaa-54c9-4892-a0e8-3b203752ea2d)


### 3. 异常分数计算

推理阶段，根据潜在向量误差和重构误差，加权计算样本的异常分数，若超过阈值则判为异常：

![image](https://github.com/user-attachments/assets/b48980e5-8e0e-4ed5-b2f1-bae3213af804)

正则化的异常分数。数据越异常，异常分数越大，越接近 1。

### 4. 算法步骤小结

- 用正常样本训练 LSTM-VAE + Discriminator，优化上述三个损失。
- 推理时，对新样本经过模型，计算异常分数。
- 设置阈值，决策是否为异常。

## 应用

1. **数据流场景应用**  

随着时间流逝数据不断到来，使用LVEAD结构对历史窗口内正常样本持续微调模型参数（如微批量增量训练）。

2. **扩展 VAE 的增量能力**   

引入基于正则化的 continual learning（如 EWC、LwF），让模型在接受新业务、新工况数据时，兼顾新旧知识。

3. **动态阈值与分布漂移感知**  

随增量数据动态调整异常分数判定阈值α和β，适应数据分布缓慢变化。

4. **多任务或多通道增量，提升泛化**  

并行维护多套Encoder/Decoder，对不同场景数据独立增量训练。

## 结论

我们设计了一种名为 VELC 的无监督深度学习异常检测方法。该模型使用 VAE 和 re-Encoder 和 constraint 网络对正常时间序列进行建模。结果表明，该模型能够利用潜在向量误差和重建误差来检测异常序列。通过广泛的实验，VELC 在 10 个数据集上的表现优于最先进的方法。VELC 在每个数据集上的出色性能也表明它是一个强大的模型，可以应用于各种应用程序。

