# 17.1 Shapley 边际贡献值

### 文献来源：[ASER - Online Class-Incremental Continual Learning with Adversarial Shapley Value](https://github.com/RenaissanceT/Continual_Learning_for_Time_Series_Survey_and_Evaluation/blob/main/Article%20Analysis/17.%20(ASER)%20Online%20Class-Incremental%20Continual%20Learning%20with%20Adversarial%20Shapley%20Value.md)

----

<img width="1153" alt="Screenshot 2024-10-21 at 2 14 06 PM" src="https://github.com/user-attachments/assets/15d7d1be-8722-45b3-9d0d-0c37350c42c9">

----

Dongsub Shim, Zheda Mai, Jihwan Jeong, Scott Sanner, Hyunwoo Kim, and Jongseong Jang. 2021. Online Class-Incremental Continual Learning with Adversarial Shapley Value. In AAAI. 9630–9638.

----

# Shapley 值是什么？

### Shapley 值的概念

**Shapley 值** 是一种来自合作博弈论的工具，用来衡量在一个合作群体中，每个参与者（或因素）对群体成功或整体收益的贡献。它被设计用来解决如何“公平地”分配收益的问题，确保每个参与者都获得与其贡献相匹配的回报。

Shapley 值的计算基于**边际贡献**的概念，意思是某个参与者（或数据点、特征等）在不同组合情况下，对整个群体的贡献大小。Shapley 值考虑所有可能的参与者排列方式，计算每个排列中该参与者的边际贡献，然后取平均值。

### 数学定义

设有一个包含 \( N \) 个参与者的合作群体，记为 \( S \)，其中每个参与者的编号为 \( i = 1, 2, ... , N \)。假设有一个收益函数 \( v(S) \)，它衡量群体 \( S \) 的总收益。Shapley 值 ϕ(i) 用来衡量参与者 \( i \) 对总收益的贡献，计算公式如下：

<img width="537" alt="Screenshot 2024-10-21 at 5 54 27 PM" src="https://github.com/user-attachments/assets/925b9def-82e8-4038-a3f2-f4a0f13be8d7">

> - S ⊆ N \ {i}：表示从群体中去掉参与者 i 后的任意子集。
> - ∣S∣：子集 S 的大小。
> - N!：表示总参与者数 𝑁 的阶乘。
> - v(S ∪ {i})：表示将参与者 𝑖 加入到子集 S 后的总收益。
> - v(S)：表示子集 S 的总收益。
> - 公式中各个部分用以计算参与者 i  在所有可能的组合中的边际贡献，然后加权取平均值。

#### 计算步骤
1. **确定所有可能的参与者组合**：对于每个参与者 \( i \)，需要考虑所有可能的子集 S ⊆ N \ {i}，即群体中不包含 i 的所有组合。
   
2. **计算边际贡献**：对于每个子集 S，计算如果将参与者  i 加入该子集后的总收益 v(S ∪ {i})，并减去未加入时的收益  v(S)，即 v(S∪{i})−v(S)。这就是该参与者在该子集中的边际贡献。

3. **加权平均**：对所有子集的边际贡献进行加权平均。

## 例子

**例子 1：团队合作的比喻**

想象你和三个朋友组队完成一个项目，最后项目成功了，获得了100元的奖金。你们每个人都做出了不同的贡献，现在需要公平地分配这笔奖金。

- **玩家A**：提出了项目的想法。
- **玩家B**：完成了大部分的实际工作。
- **玩家C**：进行了有效的协调，让团队顺利合作。
- **玩家D**：最后时刻加入，做了小部分工作。

Shapley 值的作用就是帮助你们衡量每个人对项目成功的贡献，并依据这个贡献来分配奖金。Shapley 值考虑了每个成员在各种可能的合作组合中的边际贡献，比如，如果没有某个人，团队的成功率会下降多少。

Shapley 值计算时会考虑所有可能的合作组合。例如，如果玩家A第一个加入团队，那么他们的贡献可能很大；如果最后加入，项目可能已经快完成了，因此他们的贡献会较小。通过这种方式，Shapley 值计算出每个人在各种情况下的边际贡献的平均值，最终确定出每个人应得的份额。

**例子 2：足球比赛**

在一场足球比赛中，队伍赢得了比赛。假设有前锋、后卫、守门员三个位置。我们想要评估每个球员对比赛胜利的贡献：

- **前锋**进了关键的两个球。
- **后卫**成功拦截了对手的几次进攻。
- **守门员**扑出了一个决定胜负的点球。

虽然前锋进球显然很重要，但如果没有后卫的防守或守门员的扑救，比赛可能早就输了。所以，我们需要一个方法来衡量这些不同角色的贡献。这时候，Shapley 值可以帮助我们量化每个球员的“边际贡献”，通过分析如果没有他们时的比赛情况，并对每个球员的实际贡献进行公平评估。

## **合作项目中的 Shapley 值计算**

假设一个团队有3个人 \( A \)、\( B \)、\( C \)，一起完成了一个项目，项目最终收益为100元。假设：
- 单独 \( A \) 完成时，项目收益为40元；
- 单独 \( B \) 完成时，项目收益为20元；
- 单独 \( C \) 完成时，项目收益为0元；
- \( A \) 和 \( B \) 合作时，项目收益为80元；
- \( A \) 和 \( C \) 合作时，项目收益为50元；
- \( B \) 和 \( C \) 合作时，项目收益为30元；
- 三人合作时，项目收益为100元。

我们现在计算每个人的 Shapley 值，即他们对最终收益的贡献。

1. **A 的 Shapley 值**：
   - 单独 A 的贡献：\( 40 \)
   - A 与 B 合作时的边际贡献：\( 80 - 20 = 60 \)
   - A 与 C 合作时的边际贡献：\( 50 - 0 = 50 \)
   - 三人合作时的边际贡献：\( 100 - 30 = 70 \)

   A 的 Shapley 值为：40 + 60 + 50 + 70 / 3! = 220 / 6 ≈ 36.67

2. **B 的 Shapley 值**：
   - 单独 B 的贡献：\( 20 \)
   - B 与 A 合作时的边际贡献：\( 80 - 40 = 40 \)
   - B 与 C 合作时的边际贡献：\( 30 - 0 = 30 \)
   - 三人合作时的边际贡献：\( 100 - 50 = 50 \)

   B 的 Shapley 值为：20 + 40 + 30 + 50 / 6 ≈ 23.33

4. **C 的 Shapley 值**：
   - 单独 C 的贡献：\( 0 \)
   - C 与 A 合作时的边际贡献：\( 50 - 40 = 10 \)
   - C 与 B 合作时的边际贡献：\( 30 - 20 = 10 \)
   - 三人合作时的边际贡献：\( 100 - 80 = 20 \)

   C 的 Shapley 值为：0 + 10 + 10 + 20 / 6 ≈ 6.67

最终，A、B、C 的 Shapley 值分别为 36.67、23.33 和 6.67。根据 Shapley 值，团队可以将项目收益公平地分配给每个成员。





